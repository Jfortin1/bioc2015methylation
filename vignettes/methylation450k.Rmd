<!--
 %\VignetteEngine{knitr::knitr}
-->

---
Author: Jean-Philippe Fortin, Kasper Daniel Hansen
Date: July 13, 2015
---

<!-- rmarkdown v1 -->
<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{450k methylation workflow with minfi}
-->

<!-- to compile this: library("knitr"); knit2html("methylation450k.Rmd") -->

<!--
     # a list of all required libraries:
     reqlibs = sub(".*library\\(\"(.*?)\"\\).*","\\1",grep("library\\(",readLines("methylation450k.Rmd"),value=TRUE))
     find.package(reqlibs)
-->

<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

# 450k methylation workflow with minfi

Jean-Philippe Fortin [1], Kasper Daniel Hansen [1,2]

[1] Department of Biostatistics, Johns Hopkins Bloomberg School of Public Health, Baltimore, US;

[2] McKusick-Nathans Institute of Genetic Medicine, Johns Hopkins University

```{r style, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
library("BiocStyle")
library("knitr")
options(width=100)
opts_chunk$set(message = FALSE, error = FALSE, warning = FALSE)
```

# Contents

* [Reading data](#read)
* [Building a RGSet](#construct)

# Introduction

The goal of the tutorial is to present a standard analysis workflow of 450K data with the package `r Biocpkg("minfi")`, incorporating the functions recently added to the package. We invite you to read the software paper recently published \citep{minfi} and the online package vignette on the Bioconductor project \citep{Bioc} for more details. 

We will start from the very beginning by reading input raw data (IDAT files) from an example dataset, and ending with a list of candidate genes for differential methylation. Among others, we will cover quality control assessments, different within-array and between-array normalizations, SNPs removal, sex prediction, differentially methylated positions (DMPs) analysis and bump hunting for differentially methylated regions (DMRs). 

If time permits, we will introduce a complementary interactive visualization tool package available through Bioconductor, `r Biocpkg("shinyMethyl")`, that allows interactive quality control assessment. 

#### 450k Array design and terminology
In this section, we introduce briefly the 450K array as well as the terminology used throughout the `r Biocpkg("minfi")` package. 
Each sample is measured on a single array, in two different color channels (red and green). As the name of the platform indicates, each array measures more than 450,000 CpG positions. For each CpG, we have two measurements: a methylated intensity and an unmethylated intensity. Depending on the probe design, the signals are reported in different colors:

For *Type I* design, both signals are measured in the same color: one probe for the methylated signal and one probe for the unmethylated signal. For *Type II* design, only one probe is used. The intensity read in the green channel measures the methylated signal, and the intensity read in the red channel measures the unmethylated signal.

Two commonly measures are used to report the methylation levels: Beta values and M values. 

**Beta value**:
$$\frac{M}{M + U + 100}$$

where $M$ and $U$ denote the methylated and unmethylated signals respectively. 

**MValue**:
$$Mval = \log{\biggl(\frac{M}{U}\biggr)}$$

**DMP**: Differentially methylated position: single genomic position that has a different methylated level in two different groups of samples (or conditions)

**DMR**: Differentially methylated region: when consecutive genomic locations are differentially methylated in the same direction. 

**Array**: One sample 

**Slide**: Physical slide containing 12 arrays ($6 \times 2$ grid)

**Plate** Physical plate containing at most 8 slides (96 arrays). For this tutorial, we use **batch** and plate interchangeably. 


## Reading Data
The starting point of `r Biocpkg("minfi")` is reading the .IDAT files with the built-in function *read.450k.exp*. Several options are available: the user can specify the sample filenames to be read in along with the directory path, or can specify the directory that contains the files. In the latter case, all the files with the extension .IDAT located in the directory will be loaded into \R{}. The user can also read in a sample sheet, and then use the sample sheet to load the data into a *RGChannelSet*. For more information, see the \texttt{minfi} vignette. Here, we will load the dataset containing 6 samples from the `r Biocpkg("minfiData")` package using the sample sheet provided within the package:

```{r}
library(minfi)
library(minfiData)
baseDir <- system.file("extdata",package="minfiData")
targets <- read.450k.sheet(baseDir)
targets
RGSet <- read.450k.exp(base = baseDir, targets = targets)
```

The class of RGSet is a *RGChannelSet* object. This is the initial object of a minfi analysis that contains the raw intensities in the green and red channels. Note that this object contains the intensities of the internal control probes as well. Because we read the data from a data sheet experiment, the phenotype data is also stored in the *RGChannelSet* and can be accessed via the accessor command *pData*:

```{r}
phenoData <- pData(RGSet)
phenoData[,1:6]
```

The *RGChannelSet* stores also a manifest object that contains the probe design information of the array:

```{r}
manifest <- getManifest(RGSet)
manifest
head(getProbeInfo(manifest))
```

See the [minfi vignette](http://bioconductor.org/packages/release/bioc/vignettes/minfi/inst/doc/minfi.pdf) for more information. 

## Quality control

#### QC plot 

`r Biocpkg("minfi")` provides a simple quality control plot that uses the log median intensity in both the methylated (M) and unmethylated (U) channels. When plotting these two medians against each other, it has been observed that good samples cluster together, while failed samples tend to separate and have lower median intensities. In order to obtain the methylated and unmethylated signals, we need to convert the *RGChannelSet* to an object containing the methylated and unmethylated signals using the function *preprocessRaw*. It takes as input a *RGChannelSet* and converts the red and green intensities to methylated and unmethylated signals according to the special 450K probe design, and returns the converted signals in a new object of class *MethylSet*. It does not perform any normalization.

```{r}
MSet <- preprocessRaw(RGSet) 
MSet
```

The accessors *getMeth* and *getUnmeth* can be used to get the methylated and unmethylated intensities matrices:

```{r}
head(getMeth(MSet)[,1:3])
head(getUnmeth(MSet)[,1:3])
```

The functions *getQC* and *plotQC* are designed to extract and plot the quality control information from the *MethylSet*:

```{r}
qc <- getQC(MSet)
head(qc)
plotQC(qc)
```

Moreover, the function *addQC* applied to the *MethylSet* will add the QC information to the phenotype data. 

To further explore the quality of the samples, it is useful to look at the Beta value densities of the samples, with the option to color the densities by group:

```{r}
densityPlot(MSet, sampGroups = phenoData$Sample_Group)
```

or density bean plots:

```{r}
densityBeanPlot(MSet, sampGroups = phenoData$Sample_Group)
```

`r Biocpkg("shinyMethyl")` is particularly useful to visualize all plots at the same time in an interactive fashion. 

#### Control probes plot

The 450k array contains several internal control probes that can be used to assess the quality control of different sample preparation steps (bisulfite conversion, hybridization, etc.). The values of these control probes are stored in the initial *RGChannelSet* and can be plotted by using the function *controlStripPlot* and by specifying the control probe type:

```{r}
controlStripPlot(RGSet, controls="BISULFITE CONVERSION II")
```

All the plots above can be exported into a pdf file in one step using the function *qcReport*:

```{r}
qcReport(RGSet, pdf= "qcReport.pdf")
```

## MethylSet and RatioSet
A *MethylSet* objects contains the methylated and unmethylated signals, but no methylation summary measures such as Beta values of M values. 

A *RatioSet* object is a class designed to store Beta values and/or M values instead of the methylated and unmethylated signals. An optional copy number matrix, *CN*, the sum of the methylated and unmethylated signals, can be also stored. Mapping a *MethylSet* to a *RatioSet* is irreversible, i.e. one cannot technically retrieve the methylated and unmethylated signals from a *RatioSet*.  A *RatioSet* can be created with the function *ratioConvert*:

```{r}
ratioSet <- ratioConvert(MSet, what = "both", keepCN = TRUE)
ratioSet
```

The functions *getBeta*, *getM* and *getCN* return respectively the Beta value matrix, M value matrix and a the Copy Number matrix. 

```{r}
beta <- getBeta(ratioSet)
```

## Map to Genome

The function *mapToGenome* applied to a *RatioSet* object will add genomic coordinates to each probe together with some additional annotation information. The output object is a *GenomicRatioSet* (class holding M or/and Beta values together with associated genomic coordinates). It is possible to merge the manifest object with the genomic locations by setting the option *mergeManifest* to *TRUE*.

```{r}
gset <- mapToGenome(ratioSet)
gset
```

Note that the *GenomicRatioSet* extends the class *SummarizedExperiment*. Here are the main accessors functions to access the data:

```{r}
beta <- getBeta(gset)
m <- getM(gset)
cn <- getCN(gset)
```

```{r}
sampleNames <- sampleNames(gset)
probeNames <- featureNames(gset)
pheno <- pData(gset)
```
  
To return the probe locations as a *GenomicRanges* objects, one can use the accessor *granges*:

```{r}
gr <- granges(gset)
head(gr, n= 3)
```

To access the full annotation, one can use the command *getAnnotation*:

```{r}
annotation <- getAnnotation(gset)
names(annotation)
`



